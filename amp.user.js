  // ==UserScript==
  // @name         Advanced modarchive player
  // @namespace    https://github.com/devdmytro/advanced-modarchive-player
  // @version      1.1.1
  // @description  Get more convenience from using the modarchive player
  // @author       devdmytro
  // @match        https://modarchive.org/index.php?request=view_player*
  // @icon         https://www.google.com/s2/favicons?domain=modarchive.org
  // @updateURL    https://devdmytro.github.io/advanced-modarchive-player/amp.meta.js
  // @downloadURL  https://devdmytro.github.io/advanced-modarchive-player/amp.user.js
  // @grant        none
  // ==/UserScript==
  !function(){function e(e){return window.btoa(unescape(encodeURIComponent(e)))}!function(e){"use strict";function t(e){return function(t,n){var a=i.i18n[e].indexOf(n.charAt(0).toUpperCase()+n.substr(1).toLowerCase());~a&&(t.month=a)}}function n(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function a(e,t,n){for(var a=0,i=e.length;a<i;a++)t.push(e[a].substr(0,n))}var i={},l=/d{1,4}|M{1,4}|YY(?:YY)?|S{1,3}|Do|ZZ|([HhMsDm])\1?|[aA]|"[^"]*"|'[^']*'/g,o=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],r=["January","February","March","April","May","June","July","August","September","October","November","December"],s=["am","pm"],d=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,c=function(){},m=[],p=[],u={D:[/\d\d?/,function(e,t){e.day=t}],M:[/\d\d?/,function(e,t){e.month=t-1}],YY:[/\d\d?/,function(e,t){var n=+(""+(new Date).getFullYear()).substr(0,2);e.year=""+(t>68?n-1:n)+t}],h:[/\d\d?/,function(e,t){e.hour=t}],m:[/\d\d?/,function(e,t){e.minute=t}],s:[/\d\d?/,function(e,t){e.second=t}],YYYY:[/\d{4}/,function(e,t){e.year=t}],S:[/\d/,function(e,t){e.millisecond=100*t}],SS:[/\d{2}/,function(e,t){e.millisecond=10*t}],SSS:[/\d{3}/,function(e,t){e.millisecond=t}],d:[/\d\d?/,c],ddd:[d,c],MMM:[d,t("monthNamesShort")],MMMM:[d,t("monthNames")],a:[d,function(e,t){s.indexOf(t.toLowerCase())&&(e.isPm=!0)}],ZZ:[/[\+\-]\d\d:?\d\d/,function(e,t){var n,a=(t+"").match(/([\+\-]|\d\d)/gi);a&&(n=60*a[1]+parseInt(a[2],10),e.timezoneOffset="+"===a[0]?n:-n)}]};u.dd=u.d,u.dddd=u.ddd,u.Do=u.DD=u.D,u.mm=u.m,u.hh=u.H=u.HH=u.h,u.MM=u.M,u.ss=u.s,u.A=u.a,a(r,p,3),a(o,m,3),i.i18n={dayNamesShort:m,dayNames:o,monthNamesShort:p,monthNames:r,amPm:s,DoFn:function(e){return e+["th","st","nd","rd"][e%10>3?0:(e-e%10!=10)*e%10]}},i.masks={default:"ddd MMM DD YYYY HH:mm:ss",shortDate:"M/D/YY",mediumDate:"MMM D, YYYY",longDate:"MMMM D, YYYY",fullDate:"dddd, MMMM D, YYYY",shortTime:"HH:mm",mediumTime:"HH:mm:ss",longTime:"HH:mm:ss.SSS"},i.format=function(e,t){if("string"==typeof e?e=i.parse(e):e||(e=new Date),isNaN(e))throw new SyntaxError("invalid date");t=i.masks[t]||t||i.masks.default;var a=e.getDate(),o=e.getDay(),r=e.getMonth(),s=e.getFullYear(),d=e.getHours(),c=e.getMinutes(),m=e.getSeconds(),p=e.getMilliseconds(),u=e.getTimezoneOffset(),g={D:a,DD:n(a),Do:i.i18n.DoFn(a),d:o,dd:n(o),ddd:i.i18n.dayNamesShort[o],dddd:i.i18n.dayNames[o],M:r+1,MM:n(r+1),MMM:i.i18n.monthNamesShort[r],MMMM:i.i18n.monthNames[r],YY:String(s).slice(2),YYYY:s,h:d%12||12,hh:n(d%12||12),H:d,HH:n(d),m:c,mm:n(c),s:m,ss:n(m),S:Math.round(p/100),SS:n(Math.round(p/10),2),SSS:n(p,3),a:d<12?i.i18n.amPm[0]:i.i18n.amPm[1],A:d<12?i.i18n.amPm[0].toUpperCase():i.i18n.amPm[1].toUpperCase(),ZZ:(u>0?"-":"+")+n(100*Math.floor(Math.abs(u)/60)+Math.abs(u)%60,4)};return t.replace(l,(function(e){return e in g?g[e]:e.slice(1,e.length-1)}))},i.parse=function(e,t){if(!t)return new Date(e.replace(/\-/g,"/"));t=i.masks[t]||t;var n=!0,a={};if(t.replace(l,(function(t){if(u[t]){var i=u[t],l=e.search(i[0]);~l?e.replace(i[0],(function(t){return i[1](a,t),e=e.substr(l+t.length),t})):n=!1}return u[t]?"":t.slice(1,t.length-1)})),!n)return!1;var o,r=new Date;return a.isPm&&a.hour&&(a.hour=+a.hour+12),a.timezoneOffset?(a.minute=+(a.minute||0)-+a.timezoneOffset,o=new Date(Date.UTC(a.year||r.getFullYear(),a.month||0,a.day||1,a.hour||0,a.minute||0,a.second||0,a.millisecond||0))):o=new Date(a.year||r.getFullYear(),a.month||0,a.day||1,a.hour||0,a.minute||0,a.second||0,a.millisecond||0),o},"undefined"!=typeof module&&module.exports?module.exports=i:"undefined"!=typeof require&&require.amd?define((function(){return i})):e.fecha=i}(this);var t=!1;if(ChiptuneJsPlayer.prototype.createLibopenmptNode=function(e,n){var i=4096,l=this.context.createScriptProcessor(2048,0,2);l.config=n,l.player=this;var o=new Int8Array(e),r=libopenmpt._malloc(o.byteLength);libopenmpt.HEAPU8.set(o,r),l.modulePtr=libopenmpt._openmpt_module_create_from_memory(r,o.byteLength,0,0,0);var s=stackSave();return libopenmpt._openmpt_module_ctl_set(l.modulePtr,asciiToStack("render.resampler.emulate_amiga"),asciiToStack("1")),libopenmpt._openmpt_module_ctl_set(l.modulePtr,asciiToStack("render.resampler.emulate_amiga_type"),asciiToStack("a1200")),stackRestore(s),l.paused=!1,l.leftBufferPtr=libopenmpt._malloc(16384),l.rightBufferPtr=libopenmpt._malloc(16384),l.cleanup=function(){0!=this.modulePtr&&(libopenmpt._openmpt_module_destroy(this.modulePtr),this.modulePtr=0),0!=this.leftBufferPtr&&(libopenmpt._free(this.leftBufferPtr),this.leftBufferPtr=0),0!=this.rightBufferPtr&&(libopenmpt._free(this.rightBufferPtr),this.rightBufferPtr=0)},l.stop=function(){this.disconnect(),this.cleanup()},l.pause=function(){this.paused=!0},l.unpause=function(){this.paused=!1},l.togglePause=function(){this.paused=!this.paused},l.onaudioprocess=function(e){var n=e.outputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(1),r=n.length;if(0==this.ModulePtr){for(var s=0;s<r;++s)n[s]=0,o[s]=0;return this.disconnect(),void this.cleanup()}if(this.paused)for(s=0;s<r;++s)n[s]=0,o[s]=0;else{for(var d=0,c=!1,u=!1;r>0;){var g=Math.min(r,i),y=libopenmpt._openmpt_module_read_float_stereo(this.modulePtr,this.context.sampleRate,g,this.leftBufferPtr,this.rightBufferPtr);if(0==y){if(c=!0,document.getElementById("autoplay").checked&&!t){if(t=!0,h){let e=plStore[plStore.findIndex((e=>e.id==h.id))],n=e.tracks.findIndex((e=>e.id==p.id));return n+1?n+1>=e.tracks.length?(t=!1,player.seek(0)):openP(e.tracks[n+1].id,h.id):openP(h.tids[h.tids.indexOf(p.id)].id,h.id)}return null!==new URL(window.location.href).searchParams.get("favorites")?window.location.href=`index.php?request=view_player&query=${a[a.findIndex((e=>e.id==m))+1].id}&favorites`:window.location.href="index.php?request=view_player&query=random"}u=!this.modulePtr}var f=libopenmpt.HEAPF32.subarray(this.leftBufferPtr/4,this.leftBufferPtr/4+y),v=libopenmpt.HEAPF32.subarray(this.rightBufferPtr/4,this.rightBufferPtr/4+y);for(s=0;s<y;++s)n[d+s]=f[s],o[d+s]=v[s];for(s=y;s<g;++s)n[d+s]=0,o[d+s]=0;r-=g,d+=g}c&&(this.disconnect(),this.cleanup(),u?l.player.fireEvent("onError",{type:"openmpt"}):l.player.fireEvent("onEnded"))}},l},document.cookie.includes("TMA2009ident")&&!localStorage.getItem("uid")){let e=new XMLHttpRequest;e.open("GET","/index.php?faq-switches"),e.send(),e.onload=function(){const t=(new DOMParser).parseFromString(e.response,"text/html").getElementsByTagName("ul")[1]?.children[1]?.children[0]?.href?.split("php?")[1];parseInt(t)>0&&localStorage.setItem("uid",t)}}!document.cookie.includes("TMA2009ident")&&localStorage.getItem("uid")&&(localStorage.removeItem("uid"),localStorage.removeItem("favorites")),localStorage.getItem("pin")||localStorage.setItem("pin",!1),localStorage.getItem("autoplay")||localStorage.setItem("autoplay",!1),localStorage.getItem("notifications")||localStorage.setItem("notifications",!1),localStorage.getItem("history")||localStorage.setItem("history",JSON.stringify([])),localStorage.getItem("playlists")||localStorage.setItem("playlists",JSON.stringify([])),localStorage.getItem("favorites")||localStorage.setItem("favorites",JSON.stringify([]));var n=!1,a=JSON.parse(localStorage.getItem("favorites")),i=0,l=JSON.parse(localStorage.getItem("history")),o=0;plist_loaded=!1,plist_id=0,plStore=JSON.parse(localStorage.getItem("playlists"));var r=!1,s=0,d=0,c='<div id="DOM_ID" class="tracker"><div class="up"><span class="name">NAME</span><span class="time">TIME</span></div><div class="down"><span class="tracker_id">id: TRACKER_ID</span><span class="links-container"><a class="links" href="#" onclick=openP(ocOPEN_DATA)>play</a><a class="links" id="cpTRACKER_ID" href="#" onclick=openP(ocOPEN_DATA,this.id)>copy</a><a class="links" target="_blank" href="https://api.modarchive.org/downloads.php?moduleid=TRACKER_ID#FILE_NAME">download</a><a href="#" class="links" onclick="OPENOCLIST">OPENPLIST</a></span></div></div>';copy=function(e,t){var n=document.createElement("textarea");n.innerHTML=e,document.body.appendChild(n),n.select();var a=document.execCommand("copy");return document.body.removeChild(n),document.getElementById(t).innerHTML="Copied!",window.setTimeout((()=>{t.startsWith("cp")?document.getElementById(t).innerHTML="copy":document.getElementById(t).innerHTML="playerLink"==t?"Copy player link":"Copy discord embed link"}),2e3),a},openP=function(t,n,a){if(n)if("favorites"!==n){var i=plStore[plStore.findIndex((e=>e.id==n))];let l=[];i.tracks.forEach((e=>{l.push(e.id)}));let o=e(JSON.stringify({id:i.id,name:i.name,tids:l}));a?copy(`https://modarchive.org/index.php?request=view_player&query=${t}&playlist=${o}`,a):window.location.href=`index.php?request=view_player&query=${t}&playlist=${o}`}else a?copy(`https://modarchive.org/index.php?request=view_player&query=${t}`,a):window.location.href=`index.php?request=view_player&query=${t}&favorites`;else a?copy(`https://modarchive.org/index.php?request=view_player&query=${t}`,a):window.location.href=`index.php?request=view_player&query=${t}`},load_trackers=function(){let e="";for(let t=0;t<20;t++){if(t+20*o>=l.length)return o++,void(document.getElementById("history").innerHTML+=e);const n=l[t+20*o];s&&fecha.format(new Date(s),"DDMMYY")!=fecha.format(new Date(n.time),"DDMMYY")&&(e+=`<div class="tracker date">${fecha.format(new Date(n.time),"DD MMMM YYYY")}</div>`),s=n.time,e+=c.replace("DOM_ID",`history_${n.id}`).replace("TRACKER_ID",n.id).replace("cpTRACKER_ID",`cph${n.id}`).replaceAll("NAME",n.trackName).replaceAll("ocOPEN_DATA",n.id).replaceAll("FILE_NAME",n.modName).replaceAll("TIME",fecha.format(new Date(n.time),"hh:mm a")).replaceAll("OPENPLIST","").trim()}document.getElementById("history").innerHTML+=e,o++},load_playlist=function(){var e=plist_id?plStore[plStore.findIndex((e=>e.id==plist_id))]:f;!plist_id&&(plist_id=f.id),document.getElementById("playlist").innerHTML="";let t=`<div class="tracker date">${e.name}</div>`;for(let n of e.tracks)t+=c.replace("DOM_ID",`track_${n.id}`).replace("cpTRACKER_ID",`cppt${n.id}`).replaceAll("NAME",n.id===m?"▶ "+n.trackName:n.trackName).replaceAll("ocOPEN_DATA",`${n.id},${e.id}`).replaceAll("TRACKER_ID",n.id).replaceAll("FILE_NAME",n.modName).replaceAll("TIME",`<a href="#" onclick="remove(${e.id},${n.id});">X</a>`).replaceAll('"name"','"name long"').replaceAll("OPENPLIST","").trim();document.getElementById("playlist").innerHTML+=t,plist_loaded=!0},load_playlists=function(){let t="";localStorage.getItem("uid")&&a.length&&(t=c.replaceAll("NAME","Your favourites").replace("cpTRACKER_ID","cpyfv").replaceAll(": TRACKER_ID",": favourites").replaceAll("ocOPEN_DATA",`${a[0]?.id||1},"favorites"`).replaceAll("download","").replaceAll('"name"','"name long"').replaceAll("TIME","").replaceAll("OPENPLIST","").trim()),plStore=JSON.parse(localStorage.getItem("playlists"));for(const n of plStore){let a=[];n.tracks.forEach((e=>{a.push(e.id)}));e(JSON.stringify({id:n.id,name:n.name,tids:a}));t+=c.replace("DOM_ID",`playlist_${n.id}`).replace("cpTRACKER_ID",`cpp${n.id}`).replaceAll("NAME",n.id==h?.id?"▶"+n.name:n.name).replaceAll(": TRACKER_ID",": "+n.id).replaceAll("ocOPEN_DATA",`${n.tracks[0]?.id||1},${n.id}`).replaceAll("download","").replaceAll('"name"','"name long"').replaceAll("TIME",`<a href="#" onclick="remove(${n.id});">X</a>`).replaceAll("OPENPLIST","open").replaceAll("OPENOCLIST",`(function(){ plist_loaded = false; plist_id = ${n.id}; ctab(1); })()`).trim()}document.getElementById("playlists").innerHTML=t},load_favorites=function(){if(!n&&localStorage.getItem("uid")){const e=[];let t=new XMLHttpRequest;t.open("GET",`/index.php?request=view_member_favourites_text&query=${localStorage.getItem("uid")}`),t.send(),t.onload=function(){const i=(new DOMParser).parseFromString(t.response,"text/html").getElementsByTagName("textarea")[0].value.replaceAll(/(https:\/\/api\.modarchive\.org\/downloads\.php\?moduleid=)([0-9]*)(#?)(.*)/g,"$2 $4").split("\n");if(i)return i.forEach((t=>{t.split(" ")[0]&&e.push({id:t.split(" ")[0],modName:t.split(" ")[1],trackName:t.split(" ")[1]})})),localStorage.setItem("favorites",JSON.stringify(e)),n=!0,(a=e).findIndex((e=>e.id==p.id))+1?(document.getElementsByTagName("td")[1].children[0].children[4].innerHTML="Delete from my Favourites",document.getElementsByTagName("td")[1].children[0].children[3].children[0].src="style/images/icons/delete.png"):(document.getElementsByTagName("td")[1].children[0].children[4].innerHTML="Add to My Favourites",document.getElementsByTagName("td")[1].children[0].children[3].children[0].src="style/images/icons/heart_add.png"),null!==new URL(window.location.href).searchParams.get("favorites")&&ctab(3),load_favorites()}}if(n){let t="";for(let n=0;n<20;n++){if(n+20*i>=a.length)return i++,void(document.getElementById("favorites").innerHTML+=t);const o=a[n+20*i];var e=l.find((e=>e.id==o.id));e&&(o.trackName=e.trackName),m==o.id&&(o.trackName="▶"+o.trackName),t+=c.replace("DOM_ID",`favorite_${o.id}`).replace("cpTRACKER_ID",`cpf${o.id}`).replaceAll("NAME",o.trackName).replaceAll("TRACKER_ID",o.id).replaceAll("ocOPEN_DATA",`${o.id},${null!==new URL(window.location.href).searchParams.get("favorites")&&'"favorites"'}`).replaceAll("FILE_NAME",o.modName).replaceAll("TIME","").replaceAll('"name"','"name long"').replaceAll("OPENPLIST","").trim()}document.getElementById("favorites").innerHTML+=t,i++}},togglefav=function(){if(a.findIndex((e=>e.id==m))+1){let e=new XMLHttpRequest;e.open("GET",`/interactive.php?request=remove_favourite&query=${m}`),e.send(),e.onload=function(){"Favourite Removed"===(new DOMParser).parseFromString(e.response,"text/html").getElementsByTagName("h1")[0].innerHTML&&(document.getElementsByTagName("td")[1].children[0].children[4].innerHTML="Add to My Favourites",document.getElementsByTagName("td")[1].children[0].children[3].children[0].src="style/images/icons/heart_add.png",a.splice(a.findIndex((e=>e.id==m)),1),localStorage.setItem("favorites",JSON.stringify(a)),document.getElementById(`favorite_${m}`).remove())}}else{let e=new XMLHttpRequest;e.open("GET",`/interactive.php?request=add_favourite&query=${m}`),e.send(),e.onload=function(){"Favourite Added!"===(new DOMParser).parseFromString(e.response,"text/html").getElementsByTagName("h1")[0].innerHTML&&(document.getElementsByTagName("td")[1].children[0].children[4].innerHTML="Delete from my Favourites",document.getElementsByTagName("td")[1].children[0].children[3].children[0].src="style/images/icons/delete.png",a.unshift({id:p.id,modName:p.mod,trackName:p.mod}),document.getElementById("favorites").innerHTML=c.replace("DOM_ID",`favorite_${p.id}`).replace("cpTRACKER_ID",`cpf${p.id}`).replaceAll("NAME",p.name).replaceAll("TRACKER_ID",p.id).replaceAll("ocOPEN_DATA",`${p.id},${null!==new URL(window.location.href).searchParams.get("favorites")&&'"favorites"'}`).replaceAll("FILE_NAME",p.mod).replaceAll("TIME","").replaceAll('"name"','"name long"').replaceAll("OPENPLIST","").trim()+document.getElementById("favorites").innerHTML,localStorage.setItem("favorites",JSON.stringify(a)))}}},ctab=function(e){0==e?(0==o&&load_trackers(),document.getElementById("playlist").classList.add("hide"),document.getElementById("playlists").classList.add("hide"),document.getElementById("history").classList.remove("hide"),document.getElementById("favorites").classList.add("hide"),document.getElementsByClassName("tab")[3].classList.remove("active"),document.getElementsByClassName("tab")[2].classList.remove("active"),document.getElementsByClassName("tab")[1].classList.remove("active"),document.getElementsByClassName("tab")[0].classList.add("active"),d=0):1==e?(plist_loaded||load_playlist(),document.getElementsByClassName("tab")[1].classList.remove("hide"),document.getElementById("history").classList.add("hide"),document.getElementById("playlists").classList.add("hide"),document.getElementById("playlist").classList.remove("hide"),document.getElementById("favorites").classList.add("hide"),document.getElementsByClassName("tab")[2].classList.remove("active"),document.getElementsByClassName("tab")[0].classList.remove("active"),document.getElementsByClassName("tab")[1].classList.add("active"),document.getElementsByClassName("tab")[3].classList.remove("active"),d=1):2==e?(load_playlists(),document.getElementById("history").classList.add("hide"),document.getElementById("playlist").classList.add("hide"),document.getElementById("playlists").classList.remove("hide"),document.getElementById("favorites").classList.add("hide"),document.getElementsByClassName("tab")[0].classList.remove("active"),document.getElementsByClassName("tab")[1].classList.remove("active"),document.getElementsByClassName("tab")[2].classList.add("active"),document.getElementsByClassName("tab")[3].classList.remove("active"),d=2):3==e&&(0==i&&load_favorites(),document.getElementById("history").classList.add("hide"),document.getElementById("playlist").classList.add("hide"),document.getElementById("playlists").classList.add("hide"),document.getElementById("favorites").classList.remove("hide"),document.getElementsByClassName("tab")[0].classList.remove("active"),document.getElementsByClassName("tab")[1].classList.remove("active"),document.getElementsByClassName("tab")[2].classList.remove("active"),document.getElementsByClassName("tab")[3].classList.add("active"),d=3)},toggle=function(){0==d&&0===o&&(ctab(0),load_trackers()),document.getElementsByClassName("history-window")[0].classList.toggle("hide"),document.getElementsByClassName("toggle")[0].classList.toggle("open"),r=!r},pinToggle=function(e){e.classList.toggle("pinned")},addToPlaylist=function(){const e=document.getElementById("addtoplaylist").value;if(-1!=e){if(0==e){pauseButton();const t=prompt("Enter playlist name");if(pauseButton(),t){const n={id:Date.now(),name:t,tracks:[{id:p.id,trackName:p.name,modName:p.mod}]},a=JSON.parse(localStorage.getItem("playlists"));a.push(n),localStorage.setItem("playlists",JSON.stringify(a)),document.getElementById("playlists").innerHTML+=c.replace("DOM_ID",`playlist_${e.id}`).replace("cpTRACKER_ID",`cpp${n.id}`).replaceAll("NAME",n.name).replaceAll(": TRACKER_ID",": "+n.id).replaceAll("ocOPEN_DATA",`${n.tracks[0]?.id||1},${n.id}`).replaceAll("download","").replaceAll('"name"','"name long"').replaceAll("TIME",`<a href="#" onclick="remove(${n.id});">X</a>`).replaceAll("OPENPLIST","open").replaceAll("OPENOCLIST",`(function(){ plist_loaded = false; plist_id = ${n.id}; ctab(1); })()`).trim(),I="",a.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementById("addtoplaylist").innerHTML=`\n                                <option value="-1">Add to Playlist</option>\n                                <option value="0">Create new</option>\n                                ${I}\n                            `}}else{const t=plStore.findIndex((t=>t.id==e));if(!(t+1))return alert("Playlist not found!");if(plStore[t].tracks.find((e=>e.id==p.id)))return alert("Already in playlist!");plStore[t].tracks.push({id:p.id,trackName:p.name,modName:p.mod}),localStorage.setItem("playlists",JSON.stringify(plStore)),plist_id==e&&(document.getElementById("playlist").innerHTML+=c.replace("DOM_ID",`track_${p.id}`).replace("cpTRACKER_ID",`cppt${p.id}`).replaceAll("NAME",p.id===m&&plStore[t].id==f?.id?"▶ "+p.name:p.name).replaceAll("ocOPEN_DATA",`${p.id},${plStore[t].id}`).replaceAll("TRACKER_ID",p.id).replaceAll("FILE_NAME",p.mod).replaceAll("TIME",`<a href="#" onclick="remove(${plStore[t].id},${p.id});">X</a>`).replaceAll('"name"','"name long"').replaceAll("OPENPLIST","").trim())}plStore=JSON.parse(localStorage.getItem("playlists")),document.getElementById("addtoplaylist").selectedIndex=0,I="",plStore.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementById("addtoplaylist").innerHTML=`\n                    <option value="-1">Add to Playlist</option>\n                    <option value="0">Create new</option>\n                    ${I}\n                `}},remove=function(e,t){const n=plStore.findIndex((t=>t.id==e));if(n+1)if(t){const a=plStore[n].tracks.findIndex((e=>e.id==t));if(!(a+1))return;plStore[n].tracks.splice(a,1),localStorage.setItem("playlists",JSON.stringify(plStore)),plist_id==e&&document.getElementById(`track_${t}`).remove(),I="",plStore.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementById("addtoplaylist").innerHTML=`\n                        <option value="-1">Add to Playlist</option>\n                        <option value="0">Create new</option>\n                        ${I}\n                    `}else plStore.splice(n,1),localStorage.setItem("playlists",JSON.stringify(plStore)),document.getElementById(`playlist_${e}`).remove(),I="",plStore.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementById("addtoplaylist").innerHTML=`\n                        <option value="-1">Add to Playlist</option>\n                        <option value="0">Create new</option>\n                        ${I}\n                    `};var m=parseInt(document.getElementsByClassName("intro-text")[0].innerHTML.split("ID: ")[1]),p={};let u=new XMLHttpRequest;u.open("GET",`/index.php?request=view_by_moduleid&query=${m}`),u.send(),u.onload=function(){let e=(new DOMParser).parseFromString(u.response,"text/html");var t=e.getElementsByTagName("h1")[0].childNodes[0].data,n=e.getElementsByTagName("h1")[0].children[0].innerText.replace(/([\(\)])/g,""),a=e.getElementsByClassName("stats")[2].innerHTML.split(" ")[1],i=e.getElementsByClassName("stats")[3].innerHTML.split(" ")[1],o=e.getElementsByClassName("nolist")[4].children[0]?.children[1]?.innerHTML||"???",r=e.getElementsByClassName("nolist")[4].children[0],s=e.getElementsByClassName("stats")[7].innerHTML.split("Uncompressed Size: ")[1];"???"!==o&&(r.children[1].target="_blank"),p.id=m,p.name=t,p.mod=n,p.author=o;var d=document.getElementById("seekbar").outerHTML;document.getElementsByClassName("intro-text")[0].innerHTML=`\n                <strong><a href="javascript:pauseButton()" id="play">Play</a></strong>\n                <span id="title" style="display: none;"></span>\n                <br>${d}\n                <div id="subsongs" style="display:none"><select id="subsong" onchange="selectSubsong()"></select></div>\n                <br>ID: ${m}\n                <br>Duration: <span id="duration"></span>\n                <br>Size: ${s}\n                <br>Author: ${"???"!=o?r.outerHTML:"???"}\n                <br>Hits: ${a}\n                <br>Favourites: ${i}\n                `,document.title=`${o} - ${t}`;var c={id:m,trackName:t,modName:n,time:Date.now()};if(0!=l.length&&l[0].id===c.id||(l.unshift(c),localStorage.setItem("history",JSON.stringify(l))),"granted"===Notification.permission&&JSON.parse(localStorage.getItem("notifications")||""))new Notification(`Now playing: ${o} - ${t}`,{body:`id: ${m}\nfile: ${n}\nauthor: ${o}`});else"denied"!==Notification.permission&&JSON.parse(localStorage.getItem("notifications")||"")&&Notification.requestPermission().then((function(e){if("granted"===e)new Notification(`Now playing: ${o} - ${t}`,{body:`id: ${m}\nfile:${n}\nauthor: ${o}`})}))},document.getElementsByClassName("player")[0].children[2].innerHTML='<input id="notify" type="checkbox" onclick="(localStorage.setItem(\'notifications\', JSON.stringify(!JSON.parse(localStorage.getItem(\'notifications\') || \'\'))))"> <label for="notify">Show tracker info notification on start</label>',JSON.parse(localStorage.getItem("notifications")||"")&&document.getElementById("notify").setAttribute("checked","");var g=document.getElementById("autoplay");g.setAttribute("onclick",g.getAttribute("onclick")+";localStorage.setItem('autoplay', JSON.stringify(!JSON.parse(localStorage.getItem('autoplay') || '')));"),JSON.parse(localStorage.getItem("autoplay"))?document.getElementById("autoplay").setAttribute("checked",""):document.getElementById("autoplay").checked=!1;var h,y=document.getElementsByTagName("table")[0].children[0].children[0].children[0].children[0];y.innerHTML+=`<br><a href="#" onclick="copy(https://modarchive.org/index.php?request=view_player&query=${m},'playerLink')"><span><img src="style/images/icons/page_go.png" alt="dl" border="0" class="inline"></span>&nbsp;<span id="playerLink" href="#" onclick="copy('https://modarchive.org/index.php?request=view_player&query=${m}','playerLink')" class="copy-link">Copy player link</a></span><br>`,y.innerHTML+=`<a href="#" onclick="copy(https://modarchive.org/index.php?request=view_player&query=${m},'playerLink')"><span><img src="style/images/icons/page_go.png" alt="dl" border="0" class="inline"></span>&nbsp;<span id="dsLink" href="#" onclick="copy('https://itmod.xyz/${m}','dsLink')" class="copy-link">Copy discord embed link</a>`,document.getElementsByClassName("player")[0].appendChild(document.createElement("div")).setAttribute("class","history-window"),document.getElementsByClassName("history-window")[0].classList.add("hide"),document.getElementsByClassName("history-window")[0].appendChild(document.createElement("style")).innerHTML="\n            html {\n                height: 100%;\n                overflow-x: hidden;\n            }\n            body {\n                height: 100%;\n            }\n            .player {\n                position: relative;\n            }\n            .history-window {\n                position: absolute;\n                top: 0;\n                right: 0;\n                width: 270px;\n                height: 100%;\n                background: #bebebe;\n                border-left: 1px solid black;\n            }\n            .history-container {\n                position: relative;\n                overflow-x: hidden;\n                overflow-y: auto;\n                height:calc(100% - 27px);\n            }\n            .tracker {\n                height: 34px;\n                padding: 0 4px;\n            }\n            .tracker:nth-child(2n) {\n                background: #a5a5a5;\n            }\n            .up, .down {\n                width: 100%;\n                display: inline-block;\n            }\n            .name, .tracker_id {\n                float: left;\n            }\n            .time, .links-container {\n                float: right;\n            }\n            .links {\n                margin-left: 4px;\n            }\n            .name {\n                overflow-x: hidden;\n                white-space: nowrap;\n                width: 175px;\n                display: block;\n                font-weight: 600;\n            }\n            .name.long {\n                width: 230px;\n            }\n            .hide {\n                display: none !important;\n            }\n            .toggle {\n                box-sizing: border-box;\n                width: 36px;\n                height: 36px;\n                position: absolute;\n                top: 25px;\n                right: -3px;\n                padding: 0 6px;\n                background: #bebebe;\n                border: 1px solid black;\n                border-right-color: #bebebe;\n                font-size: 22px;\n                cursor: pointer;\n                line-height: 36px;\n            }\n            .toggle.open {\n                right: 278px;\n            }\n            .tracker.date {\n                font-weight: 600;\n                text-align: center;\n                height: 16px;\n            }\n            .tabs {\n                border-top: 1px solid black;\n                border-bottom: 1px solid black;\n                width: 100%;\n                height: 24px;\n            }\n            .tab {\n                display: inline-block;\n                position: relative;\n                border-right: 1px solid black;\n                cursor: pointer;\n                text-align: center;\n                height: 16px;\n                padding: 4px;\n                background: #a5a5a5;\n            }\n            .tab.active {\n                border-bottom: 1px solid #bebebe;\n                background: #bebebe;\n                font-weight: 400;\n            }\n            .tab.pinned {\n                background: #bebebe;\n            }\n            .intro-text li {\n                list-style: none;\n                display: inline-block;\n            }\n            td {\n                display: inline-block;\n                width: 100%;\n                height: 84px;\n            }\n            td > p {\n                padding: 0 15px;\n            }\n            .dmytro {\n                margin: 1px;\n                text-decoration: none !important;\n            }\n            .amp {\n                height: 20px;\n                margin: 6px 0;\n            }\n            ",document.getElementsByClassName("history-window")[0].innerHTML+=`<div class="tabs"><div class="tab" onclick="ctab(0)">History</div><div class="tab" onclick="ctab(1)">Playlist</div><div class="tab" onclick="ctab(2)">Playlists</div><div class="tab hide" onclick="ctab(3)">Favourites</div><div class="tab ${JSON.parse(localStorage.getItem("pin"))?"pinned":null}" onclick="localStorage.setItem('pin', JSON.stringify(!JSON.parse(localStorage.getItem('pin') || '')));pinToggle(this)">📌</div></div><div id="history" class="history-container"></div><div id="playlist" class="history-container hide"></div><div id="playlists" class="history-container hide"></div><div id="favorites" class="history-container hide"></div>`,document.body.innerHTML+='<div class="toggle" onclick="toggle()">☰</div>',window.outerHeight<554&&window.resizeTo(window.outerWidth,554),window.outerWidth<550&&window.resizeTo(550,window.outerHeight);var f,v,E=new URL(window.location.href).searchParams.get("playlist");if(E)try{if(h=JSON.parse((v=E,decodeURIComponent(escape(window.atob(v))))),(f=JSON.parse(localStorage.getItem("playlists")).find((e=>e.id===h.id)))&&f.tracks.length===h.tids.length)ctab(1);else{const e=!f;let t=[];for(let n of h.tids){let a=new XMLHttpRequest;a.open("GET",`/index.php?request=view_by_moduleid&query=${n}`),a.send(),a.onload=function(){let i=(new DOMParser).parseFromString(a.response,"text/html");if(t.push({id:n,trackName:i.getElementsByTagName("h1")[0].childNodes[0].data,modName:i.getElementsByTagName("h1")[0].children[0].innerText.replace(/([\(\)])/g,"")}),n===h.tids[h.tids.length-1]){f={id:h.id,name:h.name,tracks:t};let n=JSON.parse(localStorage.getItem("playlists"));e?n.push(f):n[n.findIndex((e=>e.id===f.id))]=f,localStorage.setItem("playlists",JSON.stringify(n)),ctab(1),I="",n.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementById("addtoplaylist").innerHTML=`\n                                        <option value="-1">Add to Playlist</option>\n                                        <option value="0">Create new</option>\n                                        ${I}\n                                    `}}}}}catch(e){window.location.href=`index.php?request=view_player&query=${m}`}else document.getElementsByClassName("tab")[1].classList.add("hide");JSON.parse(localStorage.getItem("pin"))&&toggle();var I="";if(plStore.forEach((e=>{I+=`<option value="${e.id}">${e.tracks.find((e=>e.id==m))?"▶":""} ${e.name}</option>`})),document.getElementsByTagName("td")[1].children[0].innerHTML+=`\n            <br>\n            <select id="addtoplaylist" onchange="addToPlaylist()">\n                <option value="-1">Add to Playlist</option>\n                <option value="0">Create new</option>\n                ${I}\n            </select>`,document.cookie.includes("TMA2009ident")){document.getElementsByClassName("tab")[3].classList.remove("hide");const e=document.getElementsByTagName("td")[1].children[0].children[3],t=document.getElementsByTagName("td")[1].children[0].children[4];e.href="#fav",t.href="#fav",e.target="",t.target="",e.setAttribute("onclick","togglefav()"),t.setAttribute("onclick","togglefav()"),load_favorites()}document.getElementsByClassName("player")[0].innerHTML+='\n            <br>\n            <div class="amp">\n                <a class="dmytro" target="_blank" href="https://github.com/devdmytro/advanced-modarchive-player">\n                    <svg aria-hidden="true" height="18" viewBox="0 0 16 16" version="1.1" width="18" data-view-component="true">\n                        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>\n                    </svg>\n                </a>\n                <a class="dmytro" target="_blank" href="https://ko-fi.com/devdmytro">\n                    <svg width="18" height="18" viewBox="0 0 64 64"><g xmlns="http://www.w3.org/2000/svg" id="g856" transform="matrix(1.9656019,0,0,1.9656019,-2.8167172e-7,-51.10565)">\n                        <g transform="translate(0,26)" id="Group-4" style="fill:none;fill-rule:nonzero;stroke:none;stroke-width:1">\n                            <circle id="Oval" cx="16.280001" cy="16.280001" r="16.280001" style="fill:#29abe0"/>\n                            <path d="m 22.257931,8.8 h 1.607617 C 26.966324,8.8 29.48,11.313676 29.48,14.414452 v 0.330015 c 0,3.100776 -2.513676,5.614452 -5.614452,5.614452 h -1.607617 v 1.689795 c 0,1.431128 -1.160158,2.591286 -2.591286,2.591286 H 7.4312857 C 6.0001581,24.64 4.84,23.479842 4.84,22.048714 V 10.095643 C 4.84,9.3800791 5.4200791,8.8 6.1356429,8.8 Z m 0,2.996757 v 5.565405 h 1.465573 c 1.536844,0 2.782703,-1.245858 2.782703,-2.782702 0,-1.536845 -1.245859,-2.782703 -2.782703,-2.782703 z" id="Rectangle-2" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" inkscape:connector-curvature="0" style="fill:#ffffff"/>\n                        </g>\n                        <g id="Group" transform="translate(4.84,34.8)" style="fill:#ff5e5b;fill-rule:nonzero;stroke:none;stroke-width:1">\n                            <path d="M 8.36,5.2768458 C 8.7602942,4.1056152 9.7089414,3.52 11.205941,3.52 c 2.2455,0 3.077965,2.7936503 1.900934,4.62 C 12.322188,9.3575665 10.739896,10.897567 8.36,12.76 5.9801039,10.897567 4.3978123,9.3575665 3.613125,8.14 2.4360941,6.3136503 3.2685587,3.52 5.5140587,3.52 7.0110586,3.52 7.9597058,4.1056152 8.36,5.2768458 Z" id="Path-2" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" inkscape:connector-curvature="0"/>\n                        </g>\n                    </svg>\n                </a>\n                <small style="position: absolute;margin-top:1px;margin-left:2px;"> - Advanced modarchive player v 1.1.1</small></div>';var N=document.getElementById("history");N.addEventListener("scroll",(function(){N.scrollTop+N.clientHeight+100>=N.scrollHeight&&20*o<l.length&&load_trackers()}));var b=document.getElementById("favorites");b.addEventListener("scroll",(function(){b.scrollTop+b.clientHeight+100>=b.scrollHeight&&20*i<a.length&&load_favorites()}))}();