// ==UserScript==
// @name         Advanced modarchive player
// @namespace    https://github.com/devdmytro/advanced-modarchive-player
// @version      1.0.2
// @description  Get more convenience from using the modarchive player
// @author       devdmytro
// @match        https://modarchive.org/index.php?request=view_player*
// @icon         https://www.google.com/s2/favicons?domain=modarchive.org
// @updateURL    https://devdmytro.github.io/advanced-modarchive-player/amp.meta.js
// @downloadURL  https://devdmytro.github.io/advanced-modarchive-player/amp.user.js
// @grant        none
// ==/UserScript==
!function(){!function(e){"use strict";function t(e){return function(t,n){var o=a.i18n[e].indexOf(n.charAt(0).toUpperCase()+n.substr(1).toLowerCase());~o&&(t.month=o)}}function n(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function o(e,t,n){for(var o=0,a=e.length;o<a;o++)t.push(e[o].substr(0,n))}var a={},i=/d{1,4}|M{1,4}|YY(?:YY)?|S{1,3}|Do|ZZ|([HhMsDm])\1?|[aA]|"[^"]*"|'[^']*'/g,r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s=["January","February","March","April","May","June","July","August","September","October","November","December"],d=["am","pm"],l=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,c=function(){},m=[],u=[],p={D:[/\d\d?/,function(e,t){e.day=t}],M:[/\d\d?/,function(e,t){e.month=t-1}],YY:[/\d\d?/,function(e,t){var n=+(""+(new Date).getFullYear()).substr(0,2);e.year=""+(t>68?n-1:n)+t}],h:[/\d\d?/,function(e,t){e.hour=t}],m:[/\d\d?/,function(e,t){e.minute=t}],s:[/\d\d?/,function(e,t){e.second=t}],YYYY:[/\d{4}/,function(e,t){e.year=t}],S:[/\d/,function(e,t){e.millisecond=100*t}],SS:[/\d{2}/,function(e,t){e.millisecond=10*t}],SSS:[/\d{3}/,function(e,t){e.millisecond=t}],d:[/\d\d?/,c],ddd:[l,c],MMM:[l,t("monthNamesShort")],MMMM:[l,t("monthNames")],a:[l,function(e,t){d.indexOf(t.toLowerCase())&&(e.isPm=!0)}],ZZ:[/[\+\-]\d\d:?\d\d/,function(e,t){var n,o=(t+"").match(/([\+\-]|\d\d)/gi);o&&(n=60*o[1]+parseInt(o[2],10),e.timezoneOffset="+"===o[0]?n:-n)}]};p.dd=p.d,p.dddd=p.ddd,p.Do=p.DD=p.D,p.mm=p.m,p.hh=p.H=p.HH=p.h,p.MM=p.M,p.ss=p.s,p.A=p.a,o(s,u,3),o(r,m,3),a.i18n={dayNamesShort:m,dayNames:r,monthNamesShort:u,monthNames:s,amPm:d,DoFn:function(e){return e+["th","st","nd","rd"][e%10>3?0:(e-e%10!=10)*e%10]}},a.masks={default:"ddd MMM DD YYYY HH:mm:ss",shortDate:"M/D/YY",mediumDate:"MMM D, YYYY",longDate:"MMMM D, YYYY",fullDate:"dddd, MMMM D, YYYY",shortTime:"HH:mm",mediumTime:"HH:mm:ss",longTime:"HH:mm:ss.SSS"},a.format=function(e,t){if("string"==typeof e?e=a.parse(e):e||(e=new Date),isNaN(e))throw new SyntaxError("invalid date");t=a.masks[t]||t||a.masks.default;var o=e.getDate(),r=e.getDay(),s=e.getMonth(),d=e.getFullYear(),l=e.getHours(),c=e.getMinutes(),m=e.getSeconds(),u=e.getMilliseconds(),p=e.getTimezoneOffset(),h={D:o,DD:n(o),Do:a.i18n.DoFn(o),d:r,dd:n(r),ddd:a.i18n.dayNamesShort[r],dddd:a.i18n.dayNames[r],M:s+1,MM:n(s+1),MMM:a.i18n.monthNamesShort[s],MMMM:a.i18n.monthNames[s],YY:String(d).slice(2),YYYY:d,h:l%12||12,hh:n(l%12||12),H:l,HH:n(l),m:c,mm:n(c),s:m,ss:n(m),S:Math.round(u/100),SS:n(Math.round(u/10),2),SSS:n(u,3),a:l<12?a.i18n.amPm[0]:a.i18n.amPm[1],A:l<12?a.i18n.amPm[0].toUpperCase():a.i18n.amPm[1].toUpperCase(),ZZ:(p>0?"-":"+")+n(100*Math.floor(Math.abs(p)/60)+Math.abs(p)%60,4)};return t.replace(i,function(e){return e in h?h[e]:e.slice(1,e.length-1)})},a.parse=function(e,t){if(!t)return new Date(e.replace(/\-/g,"/"));t=a.masks[t]||t;var n=!0,o={};if(t.replace(i,function(t){if(p[t]){var a=p[t],i=e.search(a[0]);~i?e.replace(a[0],function(t){return a[1](o,t),e=e.substr(i+t.length),t}):n=!1}return p[t]?"":t.slice(1,t.length-1)}),!n)return!1;var r,s=new Date;return o.isPm&&o.hour&&(o.hour=+o.hour+12),o.timezoneOffset?(o.minute=+(o.minute||0)-+o.timezoneOffset,r=new Date(Date.UTC(o.year||s.getFullYear(),o.month||0,o.day||1,o.hour||0,o.minute||0,o.second||0,o.millisecond||0))):r=new Date(o.year||s.getFullYear(),o.month||0,o.day||1,o.hour||0,o.minute||0,o.second||0,o.millisecond||0),r},"undefined"!=typeof module&&module.exports?module.exports=a:"undefined"!=typeof require&&require.amd?define(function(){return a}):e.fecha=a}(this),localStorage.getItem("autoplay")||localStorage.setItem("autoplay",!1),localStorage.getItem("notifications")||localStorage.setItem("notifications",!1),localStorage.getItem("history")||localStorage.setItem("history",JSON.stringify([])),history_pages=0,opened=!1,lastTrackTime=0,copy=function(e,t){var n=document.createElement("textarea");n.innerHTML=e,document.body.appendChild(n),n.select();var o=document.execCommand("copy");return document.body.removeChild(n),document.getElementById(t).innerHTML="Copied!",window.setTimeout(()=>{t.startsWith("cp")&&(document.getElementById(t).innerHTML="copy")},2e3),o},load_trackers=function(){let e="";for(let t=0;t<20;t++){if(t+20*history_pages>=store.length)return history_pages++,void(i.innerHTML+=e);const n=store[t+20*history_pages];lastTrackTime&&fecha.format(new Date(lastTrackTime),"DDMMYY")!=fecha.format(new Date(n.time),"DDMMYY")&&(e+=`<div class="tracker date">${fecha.format(new Date(n.time),"DD MMMM YYYY")}</div>`),lastTrackTime=n.time,e+=r.replaceAll("NAME",n.trackName).replaceAll("TRACKER_ID",n.id).replaceAll("FILE_NAME",n.modName).replaceAll("TIME",fecha.format(new Date(n.time),"hh:mm a")).trim()}i.innerHTML+=e,history_pages++},toggle=function(){opened?(document.getElementsByClassName("history-window")[0].classList.add("hide"),document.getElementsByClassName("toggle")[0].classList.remove("open"),opened=!opened):(0===history_pages&&load_trackers(),document.getElementsByClassName("history-window")[0].classList.remove("hide"),document.getElementsByClassName("toggle")[0].classList.add("open"),opened=!opened)};var e=parseInt(document.getElementsByClassName("intro-text")[0].innerHTML.split("ID: ")[1]),t=document.getElementsByTagName("h1")[0].innerHTML.split("Playing ")[1].split(" / ")[0],n=document.getElementById("modfilename").innerHTML;document.title=`${e} | ${t}`,store=localStorage.getItem("history"),store?store=JSON.parse(store):store=[];var o={id:e,trackName:t,modName:n,time:Date.now()};if(0!=store.length&&store[0].id===o.id||(store.unshift(o),localStorage.setItem("history",JSON.stringify(store))),"granted"===Notification.permission&&JSON.parse(localStorage.getItem("notifications")||""))new Notification(`Now playing - ${t}`,{body:`${n}\nid: ${e}`});else"denied"!==Notification.permission&&JSON.parse(localStorage.getItem("notifications")||"")&&Notification.requestPermission().then(function(o){if("granted"===o)new Notification(`Now playing - ${t}`,{body:`${n}\nid: ${e}`})});document.getElementsByClassName("player")[0].children[2].innerHTML='<input id="notify" type="checkbox" onclick="(localStorage.setItem(\'notifications\', JSON.stringify(!JSON.parse(localStorage.getItem(\'notifications\') || \'\'))))"> <label for="notify">Show tracker info notification on start</label>',JSON.parse(localStorage.getItem("notifications")||"")&&(document.getElementById("notify").checked=!0);var a=document.getElementById("autoplay");a.setAttribute("onclick",a.getAttribute("onclick")+";localStorage.setItem('autoplay', JSON.stringify(!JSON.parse(localStorage.getItem('autoplay') || '')));"),JSON.parse(localStorage.getItem("autoplay"))?document.getElementById("autoplay").checked=!0:document.getElementById("autoplay").checked=!1,document.getElementsByTagName("table")[0].children[0].children[0].children[0].children[0].innerHTML+=`<br><a href="#" onclick="copy(https://modarchive.org/index.php?request=view_player&query=${e},'playerLink')"><span><img src="style/images/icons/page_go.png" alt="dl" border="0" class="inline"></span>&nbsp;<span id="playerLink" href="#" onclick="copy('https://modarchive.org/index.php?request=view_player&query=${e}','playerLink')" class="copy-link">Copy player link</a></span><br>`,document.getElementsByClassName("player")[0].appendChild(document.createElement("div")).setAttribute("class","history-window"),document.getElementsByClassName("history-window")[0].classList.add("hide"),document.getElementsByClassName("history-window")[0].appendChild(document.createElement("style")).innerHTML="\n    html {\n        height: 100%;\n        overflow-x: hidden;\n    }\n    body {\n        height: 100%;\n    }\n    .player {\n        position: relative;\n    }\n    .history-window {\n        position: absolute;\n        top: 0;\n        right: 0;\n        width: 260px;\n        height: 100%;\n        background: #bebebe;\n        border-left: 1px solid black;\n    }\n    .history-container {\n        position: relative;\n        overflow-x: hidden;\n        overflow-y: auto;\n        height:calc(100% - 8px);\n        padding: 4px;\n    }\n    .tracker {\n        height: 34px;\n    }\n    .tracker:nth-child(2n) {\n        background: #a5a5a5;\n    }\n    .up, .down {\n        width: 100%;\n        display: inline-block;\n    }\n    .name, .tracker_id {\n        float: left;\n    }\n    .time, .links-container {\n        float: right;\n    }\n    .links {\n        margin-left: 4px;\n    }\n    .name {\n        overflow-x: hidden;\n        white-space: nowrap;\n        width: 175px;\n        display: block;\n        font-weight: 600;\n    }\n    .hide {\n        display: none;\n    }\n    .toggle {\n        box-sizing: border-box;\n        width: 36px;\n        height: 36px;\n        position: absolute;\n        top: 32px;\n        right: -3px;\n        padding: 1px 7px;\n        background: #bebebe;\n        border: 1px solid black;\n        border-right-color: #bebebe;\n        font-size: 22px;\n        cursor: pointer;\n    }\n    .toggle.open {\n        right: 268px;\n    }\n    .tracker.date {\n        font-weight: 600;\n        text-align: center;\n        height: 16px;\n    }\n    ",document.getElementsByClassName("history-window")[0].appendChild(document.createElement("div")).setAttribute("class","history-container");var i=document.getElementsByClassName("history-container")[0],r='<div class="tracker"><div class="up"><span class="name">NAME</span><span class="time">TIME</span></div><div class="down"><span class="tracker_id">id: TRACKER_ID</span><span class="links-container"><a class="links" target="_blank" href="https://modarchive.org/index.php?request=view_player&query=TRACKER_ID">open</a><a class="links" id="cpTRACKER_ID" href="#" onclick=copy("https://modarchive.org/index.php?request=view_player&query=TRACKER_ID","cpTRACKER_ID")>copy</a><a class="links" target="_blank" href="https://api.modarchive.org/downloads.php?moduleid=TRACKER_ID#FILE_NAME">download</a></span></div></div>';document.body.appendChild(document.createElement("div")).setAttribute("class","toggle"),document.getElementsByClassName("toggle")[0].setAttribute("onclick","toggle()"),document.getElementsByClassName("toggle")[0].innerHTML="☰",i.addEventListener("scroll",function(){i.scrollTop+i.clientHeight+100>=i.scrollHeight&&20*history_pages<store.length&&load_trackers()}),550==window.outerWidth&&450==window.outerHeight&&window.resizeTo(window.outerWidth,window.outerHeight+72)}();